/*!
 * CanvasTools v1.0.0 
 * (github)https://github.com/S-mohan/canvasTools
 * (url) https://smohan.net/lab/canvastools
 * (c) smohan <https://smohan.net>
 * license MIT
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("CanvasTools",[],e):"object"==typeof exports?exports.CanvasTools=e():t.CanvasTools=e()}(this,function(){return function(t){function e(o){if(n[o])return n[o].exports;var a=n[o]={i:o,l:!1,exports:{}};return t[o].call(a.exports,a,a.exports,e),a.l=!0,a.exports}var n={};return e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:o})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=4)}([function(t,e){},function(t,e,n){"use strict";window.Element&&!Element.prototype.closest&&(Element.prototype.closest=function(t){var e,n=(this.document||this.ownerDocument).querySelectorAll(t),o=this;do{for(e=n.length;--e>=0&&n.item(e)!==o;);}while(e<0&&(o=o.parentElement));return o})},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o={rect:{panel:"stroke",name:"矩形工具"},ellipse:{panel:"stroke",name:"椭圆工具"},brush:{panel:"stroke",name:"画笔工具"},arrow:{panel:"stroke",name:"箭头工具"},mosaic:{panel:"mosaic",name:"马赛克工具"},font:{panel:"font",name:"文字工具"},rubber:{name:"橡皮擦"},undo:{name:"撤销操作"},save:{name:"保存"}},a=["#000000","#808080","#800000","#f7883a","#308430","#385ad3","#800080","#009999","#ffffff","#c0c0c0","#fb3838","#ffff00","#99cc00","#3894e4","#f31bf3","#16dcdc"],i=[12,14,16,18,20,22],s=[2,4,6],l=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=[];for(var n in o)if(function(e){return t&&!!~t.indexOf(e)}(n)){var a=o[n];e.push('<div class="canvas-tools-btn js-btn" data-panel="'+(a.panel||"")+'" data-value="'+n+'" data-action="" title="'+a.name+'">\n\t\t\t<a class="btn-toggle"><i class="canvas-tools-icon__'+n+'"></i></a>\n\t\t\t</div>')}return e.join("")},r=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"#fb3838",e="";e+='<div class="colors">',e+='<span class="color-selected"><i class="js-color-selected" style="background:'+t+'"></i></span>',e+='<div class="color-list">';for(var n=[],o=[],i=0;i<16;i++){var s='<li class="js-color" style="background:'+a[i]+'" data-value="'+a[i]+'"></li>';i<8?n.push(s):o.push(s)}return e+="<ul>"+n.join("")+"</ul>",e+="<ul>"+o.join("")+"</ul>",e+="</div>",e+="</div>"},c=function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,e='<div class="strokes">',n=0,o=s.length;n<o;n++){var a=s[n],i=["stroke","js-stroke-width"];a===t&&i.push("active"),e+='<a class="'+i.join(" ")+'" data-value="'+a+'"><i style="width:'+(a+1)+"px;height:"+(a+1)+'px;"></i></a>'}return e+="</div>"},u=function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:12,e='<select class="font-select js-font-size">',n=0,o=i.length;n<o;n++){var a=i[n];e+='<option value="'+a+'" '+(a===t?"selected":"")+">"+a+"</option>"}return e+="</select>"},f=function(){return'<label class="ambiguite-range"><span>模糊度</span><input type="range" min="0" step="0.01" max="1" value="'+(arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5)+'" class="js-mosaic-ambiguity"></label>'};e.default={getButtons:l,getColorPanel:r,getStrokePanel:c,getFontPanel:u,getAmbiguity:f},t.exports=e.default},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a=Array.prototype,i={id:/^#([\w-]+)$/,className:/^\.([\w-]+)$/,tagName:/^[\w-]+$/},s=function(t){return"[object Object]"===Object.prototype.toString.call(t)},l=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"*",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document;if("string"==typeof t){t=t.trim();var n=[];return i.id.test(t)?(n=document.getElementById(RegExp.$1),n=n?[n]:[]):n=i.className.test(t)?e.getElementsByClassName(RegExp.$1):i.tagName.test(t)?e.getElementsByTagName(t):e.querySelectorAll(t),a.slice.call(n)}return[]},r=function(t,e){if("object"===(void 0===t?"undefined":o(t))&&"function"==typeof e)if(Array.isArray(t))for(var n=0,a=t.length;n<a&&!1!==e.call(t[n],n,t[n]);n++);else if("length"in t&&"number"==typeof t.length)for(var i in t)if(!1===e.call(t[i],i,t[i]))break},c=function(t,e,n,o){var i=void 0,s=void 0;if("function"==typeof n)s=n;else{if("string"!=typeof n||"function"!=typeof o)return;i=n}i&&(s=function(e){for(var n=l(i,t),s=!1,r=0,c=n.length;r<c;r++){var u=n[r];if(u===e.target||u.contains(e.target)){s=u;break}}s&&o.apply(s,a.slice.call(arguments))}),t.addEventListener(e,s,!1)},u=function(t,e,n){return t.removeEventListener(e,n,!1)},f=function(t){return t.ownerDocument.defaultView.getComputedStyle(t,null)},d=function t(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=1,o=arguments.length;n<o;n++){var a=arguments[n];if(a&&Object.keys(a).length)for(var i in a)a.hasOwnProperty(i)&&(s(a[i])?e[i]=t(e[i],a[i]):e[i]=a[i])}return e},h=function(t,e,n,o){Array.isArray(t)||(t=[t]),r(t,function(t,a){return c(a,e,n,o)})},p=function(t,e,n){Array.isArray(t)||(t=[t]),r(t,function(t,o){return u(o,e,n)})},g=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"add",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";Array.isArray(t)||(t=[t]),r(t,function(t,o){return o.classList[e](n)})};e.default={$:l,each:r,bind:c,extend:d,unbind:u,getComputedStyles:f,classList:g,$on:h,$off:p},t.exports=e.default},function(t,e,n){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(){var t=this,e=this.canvas,n=this.context,o=this.$el,a=this.state,i=(this.config,this.rect),h=this._handles,p=this.history,v=g.default.$(".js-btn",o),m=g.default.$(".js-panel__font",o)[0],b=g.default.$(".js-panel__stroke",o)[0],w=g.default.$(".js-panel__mosaic",o)[0],x=g.default.$(".js-color-selected",o),k=g.default.$(".js-color",o),$=g.default.$(".js-stroke-width",o),T=g.default.$(".js-font-size",o),j=g.default.$(".js-mosaic-ambiguity",o);h.btnEmit=function(e){var o=this;e.stopPropagation(),"font"===a.drawType&&c.call(t,e);var s=this.getAttribute("data-panel"),l=this.getAttribute("data-value");if(g.default.each(v,function(t,e){e!==o&&g.default.classList(e,"remove","active")}),~y.indexOf(l)&&(a.drawType=l),s){g.default.classList(this,"toggle","active");var r=/active/.test(this.className),u=r?"block":"none";"stroke"===s?(m.style.display="none",w.style.display="none",b.style.display=u):"font"===s?(m.style.display=u,b.style.display="none",w.style.display="none"):"mosaic"===s&&(w.style.display=u,m.style.display="none",b.style.display="none")}if("save"===l)return void O.call(t);"undo"===l&&p.length>1&&(p.pop(),n.putImageData(p[p.length-1],0,0,0,0,i.width,i.height)),f.call(t)},h.toggleColor=function(t){var e=this.getAttribute("data-value");a.strokeColor=e,g.default.each(x,function(t,n){return n.style.background=e})},h.toggleStrokeWidth=function(t){a.strokeWidth=Number(this.getAttribute("data-value")),g.default.each($,function(t,e){var n=Number(e.getAttribute("data-value")),o=n===a.strokeWidth?"add":"remove";g.default.classList(e,o,"active")})},h.toggleFontSize=function(t){a.fontSize=Number(this.value)};var _=void 0;h.onMouseDown=function(e){if(!1!=!!~y.indexOf(a.drawType)&&"font"!==a.drawType){switch(_=A(e,i),a.lastImageData=n.getImageData(0,0,i.width,i.height),n.lineCap="round",n.lineJoin="round",n.shadowBlur=0,n.strokeStyle=a.strokeColor,n.lineWidth=a.strokeWidth,a.drawType){case"rect":s.call(t,e,_);break;case"ellipse":l.call(t,e,_);break;case"mosaic":u.call(t,e);break;case"brush":default:r.call(t,e,_)}g.default.$on(document,"mousemove",h.onMouseMove),g.default.$on(document,"mouseup",h.onMouseUp)}},h.onMouseMove=function(e){if(!1!=!!~y.indexOf(a.drawType)&&"font"!==a.drawType)switch(a.drawType){case"rect":s.call(t,e,_);break;case"ellipse":l.call(t,e,_);break;case"mosaic":u.call(t,e);break;case"brush":default:r.call(t,e,null)}},h.onMouseUp=function(e){g.default.$off(document,"mousemove",h.onMouseMove),g.default.$off(document,"mouseup",h.onMouseUp),~y.indexOf(a.drawType)&&"font"!==a.drawType&&d.call(t)},h.insertTextHelper=function(e){if(e.stopPropagation(),"font"===a.drawType){if(a.isEntry)return void c.call(t,e);M(e,a,i),a.isEntry=!0}},h.removeTextHelper=function(e){"font"!==a.drawType?P():e.target.closest("#canvas-tools-input")||c.call(t,e)},h.resize=function(n){var o=e.getBoundingClientRect();i.width=e.width,i.height=e.height,i.offsetWidth=e.offsetWidth,i.offsetHeight=e.offsetHeight,i.top=o.top,i.left=o.left,"font"===a.drawType&&a.isEntry&&c.call(t,n)},h.toggleAmbiguity=function(t){a.ambiguity=this.value,console.log(a)},g.default.$on(v,"click",h.btnEmit),g.default.$on(k,"click",h.toggleColor),g.default.$on($,"click",h.toggleStrokeWidth),g.default.$on(T,"change",h.toggleFontSize),g.default.$on(j,"change",h.toggleAmbiguity),g.default.$on(e,"mousedown",h.onMouseDown),g.default.$on(e,"click",h.insertTextHelper),g.default.$on(document,"click",h.removeTextHelper),window.addEventListener("resize",h.resize)}function s(t,e){var n=this.context,o=this.rect,a=this.state,i=A(t,o),s=i.x-e.x,l=i.y-e.y;n.clearRect(0,0,o.width,o.height),n.putImageData(a.lastImageData,0,0,0,0,o.width,o.height),n.save(),n.beginPath(),n.strokeRect(e.x,e.y,s,l),n.restore(),n.closePath()}function l(t,e){var n=this.context,o=this.rect,a=this.state,i=A(t,o),s=(i.x-e.x)/2*1,l=(i.y-e.y)/2*1,r=e.x/s+1,c=e.y/l+1;n.clearRect(0,0,o.width,o.height),n.putImageData(a.lastImageData,0,0,0,0,o.width,o.height),n.save(),n.beginPath(),n.scale(s,l),n.arc(r,c,1,0,2*Math.PI),n.restore(),n.closePath(),n.stroke()}function r(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.context,o=this.rect;if(e)n.beginPath(),n.moveTo(e.x,e.y);else{var a=A(t,o);n.lineTo(a.x,a.y),n.stroke()}}function c(t){var e=document.getElementById(k);if(!e)return void(this.state.isEntry=!1);var n=e.textContent.trim(),o=n.length;if(!n||!o)return this.state.isEntry=!1,void P();var a=g.default.getComputedStyles(e),i=this.state.fontSize||$,s=2*x,l=this.context,r=parseFloat(a.left)-this.rect.left+s-2,c=parseFloat(a.top)-this.rect.top+i,u=0,f=0;l.beginPath(),l.save(),l.fillStyle=this.state.strokeColor,l.font=this.state.fontSize+"px "+T;for(var h=0;h<o;h++){var p=n[h];u+=l.measureText(p).width,u>this.rect.width-r&&(l.fillText(n.substring(f,h),r,c),c+=i,u=0,f=h),h==o-1&&l.fillText(n.substring(f,h+1),r,c)}l.restore(),l.closePath(),this.state.isEntry=!1,P(),d.call(this)}function u(t){var e=this.context,n=this.state,o=this.rect,a=A(t,o),i=e.getImageData(a.x,a.y,1,1).data,s="rgba("+i[0]+", "+i[1]+", "+i[2]+", "+n.ambiguity+")",l=3.5*n.strokeWidth;e.beginPath(),e.save(),e.fillStyle=s,e.fillRect(a.x,a.y,l,l),e.restore()}function f(){var t=this.canvas,e=void 0;switch(this.state.drawType){case"brush":e="brush";break;case"font":e="font";break;case"mosaic":e="mosaic";break;case"rect":case"ellipse":e="crosshair";break;default:e="default"}e&&(t.className=t.className.replace(/canvas-cursor__(\w+)/,"").trim()+" canvas-cursor__"+e)}function d(){this.history.push(this.context.getImageData(0,0,this.rect.width,this.rect.height))}Object.defineProperty(e,"__esModule",{value:!0});var h=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}();n(0),n(1);var p=n(3),g=o(p),v=n(2),m=o(v),y=["rect","ellipse","brush","arrow","mosaic","font","rubber"],b="#fb3838",w=2,x=2,k="canvas-tools_text_helper",$=12,T='"Helvetica Neue",Helvetica,Arial,"Hiragino Sans GB","Hiragino Sans GB W3","WenQuanYi Micro Hei",sans-serif',j=.7,_=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:b,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:b,n=document.createElement("div");return n.className="canvas-tools__panel js-panel__stroke",n.style.cssText+="white-space: nowrap!important;",n.innerHTML=m.default.getStrokePanel(t)+m.default.getColorPanel(e),n},E=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:b,n=document.createElement("div");return n.className="canvas-tools__panel js-panel__font",n.style.cssText+="white-space: nowrap!important;",n.innerHTML=m.default.getFontPanel(t)+m.default.getColorPanel(e),n},C=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:b,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:j,n=document.createElement("div");return n.className="canvas-tools__panel js-panel__mosaic",n.style.cssText+="white-space: nowrap!important;",n.innerHTML=m.default.getStrokePanel(t)+m.default.getAmbiguity(e),n},S=function(){var t=document.getElementById(k);return t||(t=document.createElement("div"),t.setAttribute("contenteditable","plaintext-only"),t.setAttribute("spellcheck","false"),t.setAttribute("id",k),t.className=k,document.body.appendChild(t)),t.innerHTML="",t.style.cssText="display: block",t},M=function(t,e,n){var o=S(),a=e.fontSize||$,i=2*x+2,s=A(t,n),l=t.pageX,r=t.pageY,c=Math.floor(n.width-s.x)-i,u=Math.floor(n.height-s.y)-i;c<=a&&(l-=a+i-c,c=a),u<=a&&(r-=a+i-u,u=a),c>=n.width&&(c=n.width-s.x),u>=n.height&&(u=n.height-s.y);var f={"font-size":a+"px","line-height":a+"px","min-width":a+"px","min-height":a+"px","max-width":c+"px","max-height":u+"px","z-index":1990,"font-family":T,display:"block",position:"absolute",top:r+"px",left:l+"px",color:e.strokeColor,padding:x+"px",overflow:"hidden"},d="";for(var h in f)d+=h+":"+f[h]+";";return o.style.cssText=d,o.focus(),o},P=function(){var t=document.getElementById(k);t&&(t.innerHTML="",t.style.cssText="display: none")},A=function(t,e){var n=t.pageX-e.left,o=t.pageY-e.top;return n<=0&&(n=0),n>=e.width&&(n=e.width),o<=0&&(o=0),o>=e.height&&(o=e.height),{x:n,y:o}},H={container:document.body,buttons:["rect","ellipse","brush","font","mosaic","undo","save"]},N=document.createElementNS("http://www.w3.org/1999/xhtml","a"),z="download"in N,O=function(){var t="canvas_"+Date.now()+".png",e=this.canvas;if(z){var n=e.toDataURL("png");n=n.replace("image/png","image/octet-stream"),setTimeout(function(){N.href=n,N.download=t,N.dispatchEvent(new MouseEvent("click"))})}else"undefined"!=typeof navigator&&"function"==typeof e.msToBlob&&navigator.msSaveBlob?navigator.msSaveBlob(e.msToBlob(),t):console.log("您的浏览器不支持该操作")},B=function(){function t(e,n){if(a(this,t),!e||"function"!=typeof e.getContext)throw new Error("invalid canvas object");this.canvas=e,this.context=e.getContext("2d"),this.config=g.default.extend({},H,n||{}),this.history=[],this.state=Object.create(null),this.rect=Object.create(null),this._handles=Object.create(null),this.state.strokeWidth=w,this.state.fontSize=$,this.state.strokeColor=b,this.state.ambiguity=j,this.state.drawType="brush",this.state.isEntry=!1,this.rect.width=e.width,this.rect.height=e.height,this.rect.offsetWidth=e.offsetWidth,this.rect.offsetHeight=e.offsetHeight;var o=e.getBoundingClientRect();this.rect.top=o.top,this.rect.left=o.left,this.state.lastImageData=this.context.getImageData(0,0,this.rect.width,this.rect.height),d.call(this),f.call(this),this.render()}return h(t,[{key:"render",value:function(){var t=this.config,e=this.state,n=document.createElement("div");n.className="canvas-tools",n.innerHTML=m.default.getButtons(t.buttons),t.container.appendChild(n),this.$el=n,this.$el.appendChild(_(e.strokeWidth,e.strokeColor)),this.$el.appendChild(E(e.fontSize,e.strokeColor)),this.$el.appendChild(C(e.ambiguity,e.strokeColor)),i.call(this)}},{key:"refresh",value:function(){}},{key:"destory",value:function(){var t=this.canvas,e=this.$el,n=this._handles,o=g.default.$(".js-btn",e),a=g.default.$(".js-color",e),i=g.default.$(".js-stroke-width",e),s=g.default.$(".js-font-size",e),l=g.default.$(".js-mosaic-ambiguity",e),r=document.getElementById(k);g.default.$off(o,"click",n.btnEmit),g.default.$off(a,"click",n.toggleColor),g.default.$off(i,"click",n.toggleStrokeWidth),g.default.$off(s,"change",n.toggleFontSize),g.default.$off(l,"change",n.toggleAmbiguity),g.default.$off(t,"mousedown",n.onMouseDown),g.default.$off(t,"click",n.insertTextHelper),g.default.$off(document,"click",n.removeTextHelper),window.removeEventListener("resize",n.resize),r&&r.parentNoed.removeChild(r),this.canvas=null,this.context=null,this.history.length=0,this.config.container.removeChild(this.$el)}}]),t}();e.default=B,t.exports=e.default}])});